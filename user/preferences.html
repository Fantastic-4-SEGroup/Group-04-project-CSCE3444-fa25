<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MoodSync’d — Pick Genres</title>
  <link rel="stylesheet" href="../styles.css" />
  <header class="nav">
    <div class="nav__left">
      <!-- Logo slot -->
      <div class="logo" aria-label="MoodSync'd logo" href="../index.html"><img src="../images/musical-note.png" alt="Two consecutive white musical notes" width="20" height="15"> MoodSync’d</div>
    </div>
    <nav class="nav__right" aria-label="Primary">
      <a class="nav__link" id="welcomeLink">Welcome, Guest</a>
      <a href="created-user-home.html" class="nav__link">Home</a>
      <a href="#" class="nav__link">About</a>
      <a href="../general/tutorial.html" class="nav__link">How it Works</a>
      <div class="dropdown">
        <button class="nav__link dropbtn" aria-haspopup="true" aria-expanded="false">Menu</button>
        <div class="dropdown-content">
          <a href="settings.html">Settings</a>
          <a href="calendar.html">Calendar</a>
          <a href="signout.html">Sign Out</a>
      </div>
    </div>
    </nav>
  </header>

  <script type="module" defer>
    // preferences page logic (inline module to avoid adding another file)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDPMnsowBumLJVqV0JYred8mlgdy7gqOaA",
      authDomain: "mood-sync-d-98f90.firebaseapp.com",
      projectId: "mood-sync-d-98f90",
      storageBucket: "mood-sync-d-98f90.firebasestorage.app",
      messagingSenderId: "116363977039",
      appId: "1:116363977039:web:b5fd844a9ecca38983253a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // allowed genres
    const GENRES = [
      'Pop','Rock','Hip Hop','R&B','Electronic','Country','Jazz','Classical','Rapping','Latin'
    ];

    // render chips
    function renderChips(){
      const grid = document.getElementById('genreGrid');
      GENRES.forEach(g => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.textContent = g;
        btn.dataset.genre = g;
        btn.addEventListener('click', () => toggleGenre(btn));
        grid.appendChild(btn);
      });
    }

    function toggleGenre(btn){
      btn.classList.toggle('is-selected');
      updateCounter();
    }

    function updateCounter(){
      const selected = document.querySelectorAll('#genreGrid .is-selected').length;
      const counter = document.getElementById('selectedCount');
      counter.textContent = `${selected} / 3 chosen`;
      const cont = document.getElementById('prefsContinue');
      cont.disabled = (selected !== 3);
    }

    async function submitPrefs(){
      const selectedEls = Array.from(document.querySelectorAll('#genreGrid .is-selected'));
      if (selectedEls.length !== 3) return;
      const genres = selectedEls.map(el => el.dataset.genre);
      // ensure user is signed in
      const user = auth.currentUser;
      if (!user){
        // redirect to login if somehow not authenticated
        window.location.href = 'login.html';
        return;
      }
      // save preferences to user's doc
      try{
        await setDoc(doc(db, 'users', user.uid), { preferences: genres, preferencesSet: true }, { merge: true });
        // go to created user home
        window.location.href = 'created-user-home.html';
      }catch(e){
        alert('Could not save preferences: ' + (e.message || e));
      }
    }

    // wire UI on DOM ready and ensure auth exists
    document.addEventListener('DOMContentLoaded', () => {
      renderChips();
      updateCounter();
      document.getElementById('prefsContinue').addEventListener('click', submitPrefs);
      // if user not authenticated, wait for auth state then continue
      onAuthStateChanged(auth, user => {
        if (!user){
          // if not signed in, go to login
          // But allow them to sign in first; redirect for safety
          // This page is intended to be shown immediately after account creation when auth exists.
        }
      });
    });


  </script>
</head>
<body class="bg-gradient">
  <header class="nav">
    <div class="nav__left">
      <div class="logo" aria-label="MoodSync'd logo" href="../index.html"><img src="../images/musical-note.png" alt="Two consecutive white musical notes" width="20" height="15"> MoodSync’d</div>
    </div>
  </header>

  <main class="container">
    <h1 class="headline">Choose your top 3 genres</h1>
    <section class="card">
      <h2 class="card__title">Pick exactly three genres to personalize your recommendations</h2>
      <div id="genreGrid" class="mood-grid" style="grid-template-columns:repeat(5,1fr);gap:.6rem;margin-top:.6rem"></div>
      <div style="margin-top:.8rem;display:flex;align-items:center;justify-content:space-between;gap:.5rem">
        <div id="selectedCount">0 / 3 chosen</div>
        <button id="prefsContinue" class="cta" disabled>Continue</button>
      </div>
    </section>
  </main>

  <footer class="footer"><small>© <span id="year"></span> MoodSync’d</small></footer>
</body>
</html>
